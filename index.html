<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SUMO PRO CONTROL</title>

  <style>
    :root {
      --bg:#0a0c10;
      --card:#12161c;
      --neon:#00ff88;
      --blue:#2b6cff;
    }

    body{
      background:var(--bg);
      color:white;
      font-family:system-ui;
      margin:0;
      display:flex;
      justify-content:center;
    }

    .panel{
      max-width:460px;
      width:100%;
      padding:10px;
    }

    .card{
      background:var(--card);
      border-radius:20px;
      padding:12px;
      margin-bottom:10px;
      border:1px solid #1d222a;
    }

    .row{display:flex;gap:8px}

    /* ===== BOTÕES ===== */
    .btn{
      flex:1;
      height:56px;
      border:none;
      border-radius:16px;
      color:white;
      font-weight:bold;
      font-size:16px;

      background:linear-gradient(#1f2530,#0c0f14);
      box-shadow:
        inset 0 1px 1px #ffffff22,
        0 6px 0 #0004;

      transition:.08s;
    }

    .btn:active{
      transform:translateY(4px);
      box-shadow:0 2px 0 #0004;
    }

    /* DIRECIONAIS */
    .big{
      height:90px;
      font-size:26px;
    }

    /* SLIDER */
    .slider{
      width:100%;
      accent-color:var(--neon);
    }

    /* PAINEL INFO */
    .info{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      text-align:center;
      font-size:14px;
    }

    /* EFEITO NEON */
    .active{
      border:1px solid var(--neon);
      box-shadow:0 0 10px #0f84;
    }
  </style>
</head>

<body>
<div class="panel">

  <!-- ===== MODOS ===== -->
  <div class="card row">
    <button class="btn" onclick="sendCmd('!B11')">MANUAL</button>
    <button class="btn" onclick="sendCmd('!B21')">AUTO</button>
  </div>

  <!-- ===== PWM ===== -->
  <div class="card">
    Velocidade PWM
    <input id="pwm" class="slider" type="range" min="120" max="255" value="200"
           oninput="setPWM(this.value)">
  </div>

  <!-- ===== COMANDO ===== -->
  <div class="card row">

    <!-- ESQUERDA: FRENTE/TRÁS -->
    <div style="flex:1;display:flex;flex-direction:column;gap:8px">
      <button class="btn big"
              onmousedown="press(5)" onmouseup="release(5)"
              ontouchstart="press(5)" ontouchend="release(5)">▲</button>

      <button class="btn big"
              onmousedown="press(6)" onmouseup="release(6)"
              ontouchstart="press(6)" ontouchend="release(6)">▼</button>
    </div>

    <!-- DIREITA: CURVAS -->
    <div style="flex:1;display:flex;flex-direction:column;gap:8px">
      <button class="btn big"
              onmousedown="press(7)" onmouseup="release(7)"
              ontouchstart="press(7)" ontouchend="release(7)">↺</button>

      <button class="btn big"
              onmousedown="press(8)" onmouseup="release(8)"
              ontouchstart="press(8)" ontouchend="release(8)">↻</button>
    </div>

  </div>

  <!-- ===== STATUS ===== -->
  <div class="card info">
    <div id="st">offline</div>
    <div id="dist">-- cm</div>
    <div id="fps">0</div>
  </div>

  <button class="btn" onclick="connect()">CONECTAR</button>

</div>

<script>
  // ====== BLE ======
  const SERVICE="6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
  const RX="6E400002-B5A3-F393-E0A9-E50E24DCCA9E";
  const TX="6E400003-B5A3-F393-E0A9-E50E24DCCA9E";

  let rxChar, txChar;
  let queue=[];
  let busy=false;

  // ---- FILA ANTI-FLOOD ----
  async function process(){
    if(busy||!queue.length) return;
    busy=true;

    const cmd=queue.shift();
    try{
      await rxChar.writeValue(
        new TextEncoder().encode(cmd)
      );
    }catch(e){
      log("erro envio");
    }

    setTimeout(()=>{
      busy=false;
      process();
    },70);       // ← CHAVE DA ESTABILIDADE
  }

  function sendCmd(c){
    queue.push(c);
    process();
  }

  function press(id){
    sendCmd("!B"+id+"1");
    vibrate();
  }

  function release(id){
    sendCmd("!B"+id+"0");
  }

  // ===== CONEXÃO =====
  async function connect(){
    try{
      const dev=await navigator.bluetooth.requestDevice({
        filters:[{name:"Sumobix_José-MUXITO"}],
        optionalServices:[SERVICE]
      });

      const srv=await dev.gatt.connect();
      const s=await srv.getPrimaryService(SERVICE);

      rxChar=await s.getCharacteristic(RX);
      txChar=await s.getCharacteristic(TX);

      await txChar.startNotifications();
      txChar.addEventListener(
        "characteristicvaluechanged",onData);

      log("conectado");
    }catch(e){log("falha");}
  }

  // ===== RECEÇÃO =====
  function onData(e){
    const v=new TextDecoder().decode(e.target.value);
    document.getElementById("st").innerText=v;
  }

  // ===== PWM (exemplo) =====
  function setPWM(v){
    // podes no futuro mapear para comando BLE
    document.getElementById("fps").innerText=v;
  }

  // ===== UTIL =====
  function log(t){
    document.getElementById("st").innerText=t;
  }

  function vibrate(){
    if(navigator.vibrate)
      navigator.vibrate(20);
  }
</script>

</body>
</html>
